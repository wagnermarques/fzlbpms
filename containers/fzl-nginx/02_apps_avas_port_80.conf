server {
    listen 80;
    server_name localhost.com;
    root /var/www/html;
    index index.php index.html index.htm;

    # Configuracao basica para o contexto /moodle
    location /ava211 {
        # Roteamento para o Moodle - essencial para versoes 4.5+
        try_files $uri $uri/ /ava211/r.php;

        # Headers de seguranca
        add_header X-Frame-Options SAMEORIGIN;
        add_header X-Content-Type-Options nosniff;
        add_header X-XSS-Protection "1; mode=block";
    }

    # Configuracao PHP-FPM para arquivos .php no contexto /ava211
    location ~ ^/ava211(.+\.php)(/.*)?$ {
        # Divide o path_info baseado na URI
        fastcgi_split_path_info ^(/ava211.+\.php)(/.*)$;
        
        # Armazena o path_info original antes do try_files
        set $path_info $fastcgi_path_info;
        
        # Procura pelo arquivo PHP
        try_files $fastcgi_script_name $fastcgi_script_name/;
        
        # Passa para o PHP-FPM
        fastcgi_pass fzl-php8.3-fpm:9000;  # ou unix:/var/run/php/php-fpm.sock
        fastcgi_index index.php;
        include fastcgi_params;
        
        # Reaplica o path_info apos incluir fastcgi_params
        fastcgi_param PATH_INFO $path_info;
        fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;
        fastcgi_param DOCUMENT_ROOT $realpath_root;
        
        # Timeouts para uploads grandes
        fastcgi_read_timeout 300;
        fastcgi_send_timeout 300;
    }




    # Configuracao basica para o contexto /moodle
    location /moodle-une {
        # Roteamento para o Moodle - essencial para versoes 4.5+
        try_files $uri $uri/ /moodle-une/r.php;

        # Headers de seguranca
        add_header X-Frame-Options SAMEORIGIN;
        add_header X-Content-Type-Options nosniff;
        add_header X-XSS-Protection "1; mode=block";
    }


    # Configuracao PHP-FPM para arquivos .php no contexto /moodle-une
    location ~ ^/moodle-une(.+\.php)(/.*)?$ {
        # Divide o path_info baseado na URI
        fastcgi_split_path_info ^(/moodle-une.+\.php)(/.*)$;
        
        # Armazena o path_info original antes do try_files
        set $path_info $fastcgi_path_info;
        
        # Procura pelo arquivo PHP
        try_files $fastcgi_script_name $fastcgi_script_name/;
        
        # Passa para o PHP-FPM
        fastcgi_pass fzl-php8.3-fpm:9000;  # ou unix:/var/run/php/php-fpm.sock
        fastcgi_index index.php;
        include fastcgi_params;
        
        # Reaplica o path_info apos incluir fastcgi_params
        fastcgi_param PATH_INFO $path_info;
        fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;
        fastcgi_param DOCUMENT_ROOT $realpath_root;
        
        # Timeouts para uploads grandes
        fastcgi_read_timeout 300;
        fastcgi_send_timeout 300;
    }





    # Configuracao basica para o contexto /moodle
    location /fzlava {
        # Roteamento para o Moodle - essencial para versoes 4.5+
        try_files $uri $uri/ /fzlava/r.php;

        # Headers de seguranca
        add_header X-Frame-Options SAMEORIGIN;
        add_header X-Content-Type-Options nosniff;
        add_header X-XSS-Protection "1; mode=block";
    }


    # Configuracao PHP-FPM para arquivos .php no contexto /fzlava
    location ~ ^/fzlava(.+\.php)(/.*)?$ {
        # Divide o path_info baseado na URI
        fastcgi_split_path_info ^(/fzlava.+\.php)(/.*)$;
        
        # Armazena o path_info original antes do try_files
        set $path_info $fastcgi_path_info;
        
        # Procura pelo arquivo PHP
        try_files $fastcgi_script_name $fastcgi_script_name/;
        
        # Passa para o PHP-FPM
        fastcgi_pass fzl-php8.3-fpm:9000;  # ou unix:/var/run/php/php-fpm.sock
        fastcgi_index index.php;
        include fastcgi_params;
        
        # Reaplica o path_info apos incluir fastcgi_params
        fastcgi_param PATH_INFO $path_info;
        fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;
        fastcgi_param DOCUMENT_ROOT $realpath_root;
        
        # Timeouts para uploads grandes
        fastcgi_read_timeout 300;
        fastcgi_send_timeout 300;
    }




    # Configuracao PHP-FPM para arquivos .php no contexto /
    location ~ ^/(.+\.php)(/.*)?$ {
        # Divide o path_info baseado na URI
        fastcgi_split_path_info ^(/.+\.php)(/.*)$;
        
        # Armazena o path_info original antes do try_files
        set $path_info $fastcgi_path_info;
        
        # Procura pelo arquivo PHP
        try_files $fastcgi_script_name $fastcgi_script_name/;
        
        # Passa para o PHP-FPM
        fastcgi_pass fzl-php8.3-fpm:9000;  # ou unix:/var/run/php/php-fpm.sock
        fastcgi_index index.php;
        include fastcgi_params;
        
        # Reaplica o path_info apos incluir fastcgi_params
        fastcgi_param PATH_INFO $path_info;
        fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;
        fastcgi_param DOCUMENT_ROOT $realpath_root;
        
        # Timeouts para uploads grandes
        fastcgi_read_timeout 300;
        fastcgi_send_timeout 300;
    }



    # Ocultar arquivos de configuracaoo e desenvolvimento
    location ~ /\.(?!well-known).* {
        return 404;
    }




    # Bloquear acesso a arquivos internos dos moodles
    location ~ ^/ava211(/vendor/|/node_modules/|composer\.json|/readme|/README|readme\.txt|/upgrade\.txt|/UPGRADING\.md|db/install\.xml|/fixtures/|/behat/|phpunit\.xml|\.lock|environment\.xml) {
        deny all;
        return 404;
    }

    location ~ ^/moodle-une(/vendor/|/node_modules/|composer\.json|/readme|/README|readme\.txt|/upgrade\.txt|/UPGRADING\.md|db/install\.xml|/fixtures/|/behat/|phpunit\.xml|\.lock|environment\.xml) {
        deny all;
        return 404;
    }

    location ~ ^/fzlava(/vendor/|/node_modules/|composer\.json|/readme|/README|readme\.txt|/upgrade\.txt|/UPGRADING\.md|db/install\.xml|/fixtures/|/behat/|phpunit\.xml|\.lock|environment\.xml) {
        deny all;
        return 404;
    }




    # Configuraacoes para arquivos estaticos
    location ~* ^/ava211.+\.(jpg|jpeg|gif|css|png|js|ico|html|xml|txt)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
    }

    location ~* ^/moodle-une.+\.(jpg|jpeg|gif|css|png|js|ico|html|xml|txt)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
    }

    location ~* ^/fzlava.+\.(jpg|jpeg|gif|css|png|js|ico|html|xml|txt)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
    }


# Aumentar limites para uploads
    client_max_body_size 100M;
    client_body_timeout 300s;
    client_header_timeout 300s;

    # Logs
    access_log /var/log/nginx/ava211_access.log;
    error_log /var/log/nginx/ava211_error.log;
}

# Configuracaoo adicional para HTTPS (recomendado para producao)
# server {
#     listen 443 ssl http2;
#     server_name seu-dominio.com;
#     
#     ssl_certificate /path/to/certificate.crt;
#     ssl_certificate_key /path/to/private.key;
#     ssl_protocols TLSv1.2 TLSv1.3;
#     ssl_ciphers HIGH:!aNULL:!MD5;
#     ssl_prefer_server_ciphers on;
#     
#     # Resto da configuraÃ¯Â¿Â½Ã¯Â¿Â½o igual ao bloco HTTP acima
# }