server {
    listen 80;
    server_name localhost; # Ensure this handles requests without a specific hostname

    # Set the general root directory for ALL applications
    root /var/www/html;
    index index.php index.html index.htm;

    # --- 1. General Location Block for Static Files and Index ---
    location / {
        # Tries to serve a file matching the URI.
        # If not found, it tries to serve a directory matching the URI.
        # If not found, it internally redirects the request to the index.php file
        # relative to the 'root' directory. This is essential for single-entry-point apps.
        try_files $uri $uri/ /index.php?$query_string;
    }

    # --- 2. PHP-FPM Processing Block ---
    # This block processes ANY file ending in .php anywhere under the root.
    location ~ \.php$ {
        # Ensure the file exists before processing
        try_files $uri =404;

        # Pass to the PHP-FPM container (adjust name as needed)
        fastcgi_pass fzl-php8.3-fpm:9000;
        
        # Standard PHP parameters
        fastcgi_index index.php;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;

        # Timeouts (optional but helpful for large apps/uploads)
        fastcgi_read_timeout 300;
        fastcgi_send_timeout 300;
    }

    # Deny access to hidden files
    location ~ /\.ht {
        deny all;
    }
}